<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/tools/draw.js - dwv</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="dwv" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.10.0beta</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/dwv.App.html">dwv.App</a></li>
                                <li><a href="../classes/dwv.browser.html">dwv.browser</a></li>
                                <li><a href="../classes/dwv.dicom.DataReader.html">dwv.dicom.DataReader</a></li>
                                <li><a href="../classes/dwv.dicom.DicomParser.html">dwv.dicom.DicomParser</a></li>
                                <li><a href="../classes/dwv.gui.html">dwv.gui</a></li>
                                <li><a href="../classes/dwv.gui.base.html">dwv.gui.base</a></li>
                                <li><a href="../classes/dwv.gui.base.DicomTags.html">dwv.gui.base.DicomTags</a></li>
                                <li><a href="../classes/dwv.gui.base.Draw.html">dwv.gui.base.Draw</a></li>
                                <li><a href="../classes/dwv.gui.base.FileLoad.html">dwv.gui.base.FileLoad</a></li>
                                <li><a href="../classes/dwv.gui.base.Filter.html">dwv.gui.base.Filter</a></li>
                                <li><a href="../classes/dwv.gui.base.Livewire.html">dwv.gui.base.Livewire</a></li>
                                <li><a href="../classes/dwv.gui.base.Loadbox.html">dwv.gui.base.Loadbox</a></li>
                                <li><a href="../classes/dwv.gui.base.Scroll.html">dwv.gui.base.Scroll</a></li>
                                <li><a href="../classes/dwv.gui.base.Sharpen.html">dwv.gui.base.Sharpen</a></li>
                                <li><a href="../classes/dwv.gui.base.Slider.html">dwv.gui.base.Slider</a></li>
                                <li><a href="../classes/dwv.gui.base.Sobel.html">dwv.gui.base.Sobel</a></li>
                                <li><a href="../classes/dwv.gui.base.Threshold.html">dwv.gui.base.Threshold</a></li>
                                <li><a href="../classes/dwv.gui.base.Toolbox.html">dwv.gui.base.Toolbox</a></li>
                                <li><a href="../classes/dwv.gui.base.Undo.html">dwv.gui.base.Undo</a></li>
                                <li><a href="../classes/dwv.gui.base.WindowLevel.html">dwv.gui.base.WindowLevel</a></li>
                                <li><a href="../classes/dwv.gui.base.ZoomAndPan.html">dwv.gui.base.ZoomAndPan</a></li>
                                <li><a href="../classes/dwv.html.html">dwv.html</a></li>
                                <li><a href="../classes/dwv.html.Layer.html">dwv.html.Layer</a></li>
                                <li><a href="../classes/dwv.html.Style.html">dwv.html.Style</a></li>
                                <li><a href="../classes/dwv.image.html">dwv.image</a></li>
                                <li><a href="../classes/dwv.image.filter.Sharpen.html">dwv.image.filter.Sharpen</a></li>
                                <li><a href="../classes/dwv.image.filter.Sobel.html">dwv.image.filter.Sobel</a></li>
                                <li><a href="../classes/dwv.image.filter.Threshold.html">dwv.image.filter.Threshold</a></li>
                                <li><a href="../classes/dwv.image.Geometry.html">dwv.image.Geometry</a></li>
                                <li><a href="../classes/dwv.image.Image.html">dwv.image.Image</a></li>
                                <li><a href="../classes/dwv.image.ImageFactory.html">dwv.image.ImageFactory</a></li>
                                <li><a href="../classes/dwv.image.lut.Rescale.html">dwv.image.lut.Rescale</a></li>
                                <li><a href="../classes/dwv.image.lut.Window.html">dwv.image.lut.Window</a></li>
                                <li><a href="../classes/dwv.image.RescaleSlopeAndIntercept.html">dwv.image.RescaleSlopeAndIntercept</a></li>
                                <li><a href="../classes/dwv.image.Size.html">dwv.image.Size</a></li>
                                <li><a href="../classes/dwv.image.Spacing.html">dwv.image.Spacing</a></li>
                                <li><a href="../classes/dwv.image.View.html">dwv.image.View</a></li>
                                <li><a href="../classes/dwv.image.ViewFactory.html">dwv.image.ViewFactory</a></li>
                                <li><a href="../classes/dwv.info.html">dwv.info</a></li>
                                <li><a href="../classes/dwv.info.MiniColourMap.html">dwv.info.MiniColourMap</a></li>
                                <li><a href="../classes/dwv.info.Plot.html">dwv.info.Plot</a></li>
                                <li><a href="../classes/dwv.info.Position.html">dwv.info.Position</a></li>
                                <li><a href="../classes/dwv.info.WindowLevel.html">dwv.info.WindowLevel</a></li>
                                <li><a href="../classes/dwv.io.html">dwv.io</a></li>
                                <li><a href="../classes/dwv.io.File.html">dwv.io.File</a></li>
                                <li><a href="../classes/dwv.io.Url.html">dwv.io.Url</a></li>
                                <li><a href="../classes/dwv.math.html">dwv.math</a></li>
                                <li><a href="../classes/dwv.math.BucketQueue.html">dwv.math.BucketQueue</a></li>
                                <li><a href="../classes/dwv.math.Circle.html">dwv.math.Circle</a></li>
                                <li><a href="../classes/dwv.math.Ellipse.html">dwv.math.Ellipse</a></li>
                                <li><a href="../classes/dwv.math.FastPoint2D.html">dwv.math.FastPoint2D</a></li>
                                <li><a href="../classes/dwv.math.IdGenerator.html">dwv.math.IdGenerator</a></li>
                                <li><a href="../classes/dwv.math.Index3D.html">dwv.math.Index3D</a></li>
                                <li><a href="../classes/dwv.math.Line.html">dwv.math.Line</a></li>
                                <li><a href="../classes/dwv.math.Path.html">dwv.math.Path</a></li>
                                <li><a href="../classes/dwv.math.Point2D.html">dwv.math.Point2D</a></li>
                                <li><a href="../classes/dwv.math.Point3D.html">dwv.math.Point3D</a></li>
                                <li><a href="../classes/dwv.math.Rectangle.html">dwv.math.Rectangle</a></li>
                                <li><a href="../classes/dwv.math.ROI.html">dwv.math.ROI</a></li>
                                <li><a href="../classes/dwv.math.Scissors.html">dwv.math.Scissors</a></li>
                                <li><a href="../classes/dwv.State.html">dwv.State</a></li>
                                <li><a href="../classes/dwv.tool.html">dwv.tool</a></li>
                                <li><a href="../classes/dwv.tool.ChangeGroupCommand.html">dwv.tool.ChangeGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.DeleteGroupCommand.html">dwv.tool.DeleteGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.Draw.html">dwv.tool.Draw</a></li>
                                <li><a href="../classes/dwv.tool.DrawGroupCommand.html">dwv.tool.DrawGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.EllipseFactory.html">dwv.tool.EllipseFactory</a></li>
                                <li><a href="../classes/dwv.tool.Filter.html">dwv.tool.Filter</a></li>
                                <li><a href="../classes/dwv.tool.filter.Sharpen.html">dwv.tool.filter.Sharpen</a></li>
                                <li><a href="../classes/dwv.tool.filter.Sobel.html">dwv.tool.filter.Sobel</a></li>
                                <li><a href="../classes/dwv.tool.filter.Threshold.html">dwv.tool.filter.Threshold</a></li>
                                <li><a href="../classes/dwv.tool.LineFactory.html">dwv.tool.LineFactory</a></li>
                                <li><a href="../classes/dwv.tool.Livewire.html">dwv.tool.Livewire</a></li>
                                <li><a href="../classes/dwv.tool.MoveGroupCommand.html">dwv.tool.MoveGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.ProtractorFactory.html">dwv.tool.ProtractorFactory</a></li>
                                <li><a href="../classes/dwv.tool.RectangleFactory.html">dwv.tool.RectangleFactory</a></li>
                                <li><a href="../classes/dwv.tool.RoiFactory.html">dwv.tool.RoiFactory</a></li>
                                <li><a href="../classes/dwv.tool.RunFilterCommand.html">dwv.tool.RunFilterCommand</a></li>
                                <li><a href="../classes/dwv.tool.Scroll.html">dwv.tool.Scroll</a></li>
                                <li><a href="../classes/dwv.tool.ShapeEditor.html">dwv.tool.ShapeEditor</a></li>
                                <li><a href="../classes/dwv.tool.Toolbox.html">dwv.tool.Toolbox</a></li>
                                <li><a href="../classes/dwv.tool.UndoStack.html">dwv.tool.UndoStack</a></li>
                                <li><a href="../classes/dwv.tool.WindowLevel.html">dwv.tool.WindowLevel</a></li>
                                <li><a href="../classes/dwv.tool.ZoomAndPan.html">dwv.tool.ZoomAndPan</a></li>
                                <li><a href="../classes/dwv.ToolboxController.html">dwv.ToolboxController</a></li>
                                <li><a href="../classes/dwv.utils.html">dwv.utils</a></li>
                                <li><a href="../classes/dwv.ViewController.html">dwv.ViewController</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/browser.html">browser</a></li>
                                <li><a href="../modules/dicom.html">dicom</a></li>
                                <li><a href="../modules/gui.html">gui</a></li>
                                <li><a href="../modules/html.html">html</a></li>
                                <li><a href="../modules/image.html">image</a></li>
                                <li><a href="../modules/info.html">info</a></li>
                                <li><a href="../modules/io.html">io</a></li>
                                <li><a href="../modules/math.html">math</a></li>
                                <li><a href="../modules/tool.html">tool</a></li>
                                <li><a href="../modules/utils.html">utils</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/tools/draw.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/** 
 * Tool module.
 * @module tool
 */
var dwv = dwv || {};
dwv.tool = dwv.tool || {};
var Kinetic = Kinetic || {};

/**
 * Draw group command.
 * @class DrawGroupCommand
 * @namespace dwv.tool
 * @constructor
 */
dwv.tool.DrawGroupCommand = function (group, name, layer)
{
    /**
     * Get the command name.
     * @method getName
     * @return {String} The command name.
     */
    this.getName = function () { return &quot;Draw-&quot;+name; };
    /**
     * Execute the command.
     * @method execute
     */
    this.execute = function () {
        // add the group to the layer
        layer.add(group);
        // draw
        layer.draw();
        // callback
        this.onExecute({&#x27;type&#x27;: &#x27;draw-create&#x27;, &#x27;id&#x27;: group.id});
    };
    /**
     * Undo the command.
     * @method undo
     */
    this.undo = function () {
        // remove the group from the parent layer
        group.remove();
        // draw
        layer.draw();
        // callback
        this.onUndo({&#x27;type&#x27;: &#x27;draw-delete&#x27;, &#x27;id&#x27;: group.id});
    };
}; // DrawGroupCommand class

/**
 * Handle an execute event.
 * @method onExecute
 * @param {Object} event The execute event with type and id.
 */
dwv.tool.DrawGroupCommand.prototype.onExecute = function (/*event*/) 
{
    // default does nothing.
};
/**
 * Handle an undo event.
 * @method onUndo
 * @param {Object} event The undo event with type and id.
 */
dwv.tool.DrawGroupCommand.prototype.onUndo = function (/*event*/) 
{
    // default does nothing.
};

/**
 * Move group command.
 * @class MoveGroupCommand
 * @namespace dwv.tool
 * @constructor
 */
dwv.tool.MoveGroupCommand = function (group, name, translation, layer)
{
    /**
     * Get the command name.
     * @method getName
     * @return {String} The command name.
     */
    this.getName = function () { return &quot;Move-&quot;+name; };

    /**
     * Execute the command.
     * @method execute
     */
    this.execute = function () {
        // translate all children of group
        group.getChildren().each( function (shape) {
            shape.x( shape.x() + translation.x );
            shape.y( shape.y() + translation.y );
        });
        // draw
        layer.draw();
        // callback
        this.onExecute({&#x27;type&#x27;: &#x27;draw-move&#x27;, &#x27;id&#x27;: group.id});
    };
    /**
     * Undo the command.
     * @method undo
     */
    this.undo = function () {
        // invert translate all children of group
        group.getChildren().each( function (shape) {
            shape.x( shape.x() - translation.x );
            shape.y( shape.y() - translation.y );
        });
        // draw
        layer.draw();
        // callback
        this.onUndo({&#x27;type&#x27;: &#x27;draw-move&#x27;, &#x27;id&#x27;: group.id});
    };
}; // MoveGroupCommand class

/**
 * Handle an execute event.
 * @method onExecute
 * @param {Object} event The execute event with type and id.
 */
dwv.tool.MoveGroupCommand.prototype.onExecute = function (/*event*/) 
{
    // default does nothing.
};
/**
 * Handle an undo event.
 * @method onUndo
 * @param {Object} event The undo event with type and id.
 */
dwv.tool.MoveGroupCommand.prototype.onUndo = function (/*event*/) 
{
    // default does nothing.
};

/**
 * Change group command.
 * @class ChangeGroupCommand
 * @namespace dwv.tool
 * @constructor
 */
dwv.tool.ChangeGroupCommand = function (name, func, startAnchor, endAnchor, layer, image)
{
    /**
     * Get the command name.
     * @method getName
     * @return {String} The command name.
     */
    this.getName = function () { return &quot;Change-&quot;+name; };

    /**
     * Execute the command.
     * @method execute
     */
    this.execute = function () {
        // change shape
        func( endAnchor, image );
        // draw
        layer.draw();
        // callback
        this.onExecute({&#x27;type&#x27;: &#x27;draw-change&#x27;});
    };
    /**
     * Undo the command.
     * @method undo
     */
    this.undo = function () {
        // invert change shape
        func( startAnchor, image );
        // draw
        layer.draw();
        // callback
        this.onUndo({&#x27;type&#x27;: &#x27;draw-change&#x27;});
    };
}; // ChangeGroupCommand class

/**
 * Handle an execute event.
 * @method onExecute
 * @param {Object} event The execute event with type and id.
 */
dwv.tool.ChangeGroupCommand.prototype.onExecute = function (/*event*/) 
{
    // default does nothing.
};
/**
 * Handle an undo event.
 * @method onUndo
 * @param {Object} event The undo event with type and id.
 */
dwv.tool.ChangeGroupCommand.prototype.onUndo = function (/*event*/) 
{
    // default does nothing.
};

/**
 * Delete group command.
 * @class DeleteGroupCommand
 * @namespace dwv.tool
 * @constructor
 */
dwv.tool.DeleteGroupCommand = function (group, name, layer)
{
    /**
     * Get the command name.
     * @method getName
     * @return {String} The command name.
     */
    this.getName = function () { return &quot;Delete-&quot;+name; };
    /**
     * Execute the command.
     * @method execute
     */
    this.execute = function () {
        // remove the group from the parent layer
        group.remove();
        // draw
        layer.draw();
        // callback
        this.onExecute({&#x27;type&#x27;: &#x27;draw-delete&#x27;, &#x27;id&#x27;: group.id});
    };
    /**
     * Undo the command.
     * @method undo
     */
    this.undo = function () {
        // add the group to the layer
        layer.add(group);
        // draw
        layer.draw();
        // callback
        this.onUndo({&#x27;type&#x27;: &#x27;draw-create&#x27;, &#x27;id&#x27;: group.id});
    };
}; // DeleteGroupCommand class

/**
 * Handle an execute event.
 * @method onExecute
 * @param {Object} event The execute event with type and id.
 */
dwv.tool.DeleteGroupCommand.prototype.onExecute = function (/*event*/) 
{
    // default does nothing.
};
/**
 * Handle an undo event.
 * @method onUndo
 * @param {Object} event The undo event with type and id.
 */
dwv.tool.DeleteGroupCommand.prototype.onUndo = function (/*event*/) 
{
    // default does nothing.
};

/**
 * Drawing tool.
 * @class Draw
 * @namespace dwv.tool
 * @constructor
 * @param {Object} app The associated application.
 */
dwv.tool.Draw = function (app, shapeFactoryList)
{
    /**
     * Closure to self: to be used by event handlers.
     * @property self
     * @private
     * @type WindowLevel
     */
    var self = this;
    /**
     * Draw GUI.
     * @property gui
     * @type Object
     */
    var gui = null;
    /**
     * Interaction start flag.
     * @property started
     * @private
     * @type Boolean
     */
    var started = false;
    
    /**
     * Shape factory list
     * @property shapeFactoryList
     * @type Object
     */
    this.shapeFactoryList = shapeFactoryList;
    /**
     * Draw command.
     * @property command
     * @private
     * @type Object
     */
    var command = null;
    /**
     * Current shape group.
     * @property shapeGroup
     * @private
     * @type Object
     */
    var shapeGroup = null;

    /**
     * Shape name.
     * @property shapeName
     * @type String
     */
    this.shapeName = 0;
    
    /**
     * List of points.
     * @property points
     * @private
     * @type Array
     */
    var points = [];
    
    /**
     * Last selected point.
     * @property lastPoint
     * @private
     * @type Object
     */
    var lastPoint = null;
    
    /**
     * Shape editor.
     * @property shapeEditor
     * @private
     * @type Object
     */
    var shapeEditor = new dwv.tool.ShapeEditor(app);
    
    // associate the event listeners of the editor
    //  with those of the draw tool
    shapeEditor.setDrawEventCallback(fireEvent);

    /**
     * Trash draw: a cross.
     * @property trash
     * @private
     * @type Object
     */
    var trash = new Kinetic.Group();

    // first line of the cross
    var trashLine1 = new Kinetic.Line({
        points: [-10, -10, 10, 10 ],
        stroke: &#x27;red&#x27;,
    });
    // second line of the cross
    var trashLine2 = new Kinetic.Line({
        points: [10, -10, -10, 10 ],
        stroke: &#x27;red&#x27;
    });
    trash.add(trashLine1);
    trash.add(trashLine2);

    // listeners
    var listeners = {};

    /**
     * The associated draw layer.
     * @property drawLayer
     * @private
     * @type Object
     */
    var drawLayer = null;
    
    /**
     * The associated draw layer.
     * @property drawLayer
     * @private
     * @type Object
     */
    var idGenerator = new dwv.math.IdGenerator();

    /**
     * Handle mouse down event.
     * @method mousedown
     * @param {Object} event The mouse down event.
     */
    this.mousedown = function(event){
        // determine if the click happened in an existing shape
        var stage = app.getDrawStage();
        var kshape = stage.getIntersection({
            x: event._xs, 
            y: event._ys
        });
        
        if ( kshape ) {
            var group = kshape.getParent();
            var selectedShape = group.find(&quot;.shape&quot;)[0];
            // reset editor if click on other shape
            // (and avoid anchors mouse down)
            if ( selectedShape &amp;&amp; selectedShape !== shapeEditor.getShape() ) { 
                shapeEditor.disable();
                shapeEditor.setShape(selectedShape);
                shapeEditor.setImage(app.getImage());
                shapeEditor.enable();
            }
        }
        else {
            // disable edition
            shapeEditor.disable();
            shapeEditor.setShape(null);
            shapeEditor.setImage(null);
            // start storing points
            started = true;
            // clear array
            points = [];
            // store point
            lastPoint = new dwv.math.Point2D(event._x, event._y);
            points.push(lastPoint);
        }
    };

    /**
     * Handle mouse move event.
     * @method mousemove
     * @param {Object} event The mouse move event.
     */
    this.mousemove = function(event){
        if (!started)
        {
            return;
        }
        if ( Math.abs( event._x - lastPoint.getX() ) &gt; 0 ||
                Math.abs( event._y - lastPoint.getY() ) &gt; 0 )
        {
            // current point
            lastPoint = new dwv.math.Point2D(event._x, event._y);
            // clear last added point from the list (but not the first one)
            if ( points.length != 1 ) {
                points.pop();
            }
            // add current one to the list
            points.push( lastPoint );
            // allow for anchor points
            var factory = new self.shapeFactoryList[self.shapeName]();
            if( points.length &lt; factory.getNPoints() ) {
                clearTimeout(this.timer);
                this.timer = setTimeout( function () {
                    points.push( lastPoint );
                }, factory.getTimeout() );
            }
            // remove previous draw
            if ( shapeGroup ) {
                shapeGroup.destroy();
            }
            // create shape group
            shapeGroup = factory.create(points, app.getStyle(), app.getImage());
            // do not listen during creation
            var shape = shapeGroup.getChildren( function (node) {
                return node.name() === &#x27;shape&#x27;;
            })[0];
            shape.listening(false);
            drawLayer.hitGraphEnabled(false);
            // draw shape command
            command = new dwv.tool.DrawGroupCommand(shapeGroup, self.shapeName, drawLayer);
            // draw
            command.execute();
        }
    };

    /**
     * Handle mouse up event.
     * @method mouseup
     * @param {Object} event The mouse up event.
     */
    this.mouseup = function (/*event*/){
        if (started &amp;&amp; points.length &gt; 1 )
        {
            // reset shape group
            if ( shapeGroup ) {
                shapeGroup.destroy();
            }
            // create final shape
            var factory = new self.shapeFactoryList[self.shapeName]();
            var group = factory.create(points, app.getStyle(), app.getImage());
            group.id( idGenerator.get() );
            // re-activate layer
            drawLayer.hitGraphEnabled(true);
            // draw shape command
            command = new dwv.tool.DrawGroupCommand(group, self.shapeName, drawLayer);
            command.onExecute = fireEvent;
            command.onUndo = fireEvent;
            // execute it
            command.execute();
            // save it in undo stack
            app.getUndoStack().add(command);
            
            // set shape on
            var shape = group.getChildren( function (node) {
                return node.name() === &#x27;shape&#x27;;
            })[0];
            self.setShapeOn( shape );
        }
        // reset flag
        started = false;
    };
    
    /**
     * Handle mouse out event.
     * @method mouseout
     * @param {Object} event The mouse out event.
     */
    this.mouseout = function(event){
        self.mouseup(event);
    };

    /**
     * Handle touch start event.
     * @method touchstart
     * @param {Object} event The touch start event.
     */
    this.touchstart = function(event){
        self.mousedown(event);
    };

    /**
     * Handle touch move event.
     * @method touchmove
     * @param {Object} event The touch move event.
     */
    this.touchmove = function(event){
        self.mousemove(event);
    };

    /**
     * Handle touch end event.
     * @method touchend
     * @param {Object} event The touch end event.
     */
    this.touchend = function(event){
        self.mouseup(event);
    };

    /**
     * Handle key down event.
     * @method keydown
     * @param {Object} event The key down event.
     */
    this.keydown = function(event){
        app.onKeydown(event);
    };

    /**
     * Setup the tool GUI.
     * @method setup
     */
    this.setup = function ()
    {
        gui = new dwv.gui.Draw(app);
        gui.setup(this.shapeFactoryList);
    };
    
    /**
     * Enable the tool.
     * @method enable
     * @param {Boolean} flag The flag to enable or not.
     */
    this.display = function ( flag ){
        if ( gui ) {
            gui.display( flag );
        }
        // reset shape display properties
        shapeEditor.disable();
        shapeEditor.setShape(null);
        shapeEditor.setImage(null);
        document.body.style.cursor = &#x27;default&#x27;;
        // make layer listen or not to events
        app.getDrawStage().listening( flag );
        drawLayer = app.getDrawLayer();
        drawLayer.listening( flag );
        drawLayer.hitGraphEnabled( flag );
        // get the list of shapes
        var groups = drawLayer.getChildren();
        var shapes = [];
        var fshape = function (node) {
            return node.name() === &#x27;shape&#x27;;
        };
        for ( var i = 0; i &lt; groups.length; ++i ) {
            // should only be one shape per group
            shapes.push( groups[i].getChildren(fshape)[0] );
        }
        // set shape display properties
        if ( flag ) {
            app.addLayerListeners( app.getDrawStage().getContent() );
            shapes.forEach( function (shape){ self.setShapeOn( shape ); });
        }
        else {
            app.removeLayerListeners( app.getDrawStage().getContent() );
            shapes.forEach( function (shape){ setShapeOff( shape ); });
        }
        // draw
        drawLayer.draw();
    };
    
    /**
     * Set shape off properties.
     * @method setShapeOff
     * @param {Object} shape The shape to set off.
     */
    function setShapeOff( shape ) {
        // mouse styling
        shape.off(&#x27;mouseover&#x27;);
        shape.off(&#x27;mouseout&#x27;);
        // drag
        shape.draggable(false);
        shape.off(&#x27;dragstart&#x27;);
        shape.off(&#x27;dragmove&#x27;);
        shape.off(&#x27;dragend&#x27;);
    }

    /**
     * Get the real position from an event.
     */
    function getRealPosition( index ) {
        var stage = app.getDrawStage();
        return { &#x27;x&#x27;: stage.offset().x + index.x / stage.scale().x,
            &#x27;y&#x27;: stage.offset().y + index.y / stage.scale().y };
    }
    
    /**
     * Set shape on properties.
     * @method setShapeOn
     * @param {Object} shape The shape to set on.
     */
    this.setShapeOn = function ( shape ) {
        // mouse over styling
        shape.on(&#x27;mouseover&#x27;, function () {
            document.body.style.cursor = &#x27;pointer&#x27;;
        });
        // mouse out styling
        shape.on(&#x27;mouseout&#x27;, function () {
            document.body.style.cursor = &#x27;default&#x27;;
        });

        // make it draggable
        shape.draggable(true);
        var dragStartPos = null;
        var dragLastPos = null;
        
        // command name based on shape type
        var cmdName = &quot;shape&quot;;
        if ( shape instanceof Kinetic.Line ) {
            if ( shape.points().length == 4 ) {
                cmdName = &quot;line&quot;;
            }
            else if ( shape.points().length == 6 ) {
                cmdName = &quot;protractor&quot;;
            }
            else {
                cmdName = &quot;roi&quot;;
            }
        }
        else if ( shape instanceof Kinetic.Rect ) {
            cmdName = &quot;rectangle&quot;;
        }
        else if ( shape instanceof Kinetic.Ellipse ) {
            cmdName = &quot;ellipse&quot;;
        }
        
        // shape colour
        var colour = shape.stroke();
        
        // drag start event handling
        shape.on(&#x27;dragstart&#x27;, function (event) {
            // save start position
            var offset = dwv.html.getEventOffset( event.evt )[0];
            dragStartPos = getRealPosition( offset );
            // display trash
            var stage = app.getDrawStage();
            var scale = stage.scale();
            var invscale = {&#x27;x&#x27;: 1/scale.x, &#x27;y&#x27;: 1/scale.y};
            trash.x( stage.offset().x + ( 256 / scale.x ) );
            trash.y( stage.offset().y + ( 20 / scale.y ) );
            trash.scale( invscale );
            drawLayer.add( trash );
            // deactivate anchors to avoid events on null shape
            shapeEditor.setAnchorsActive(false);
            // draw
            drawLayer.draw();
        });
        // drag move event handling
        shape.on(&#x27;dragmove&#x27;, function (event) {
            var offset = dwv.html.getEventOffset( event.evt )[0];
            var pos = getRealPosition( offset );
            var translation;
            if ( dragLastPos ) {
                translation = {&#x27;x&#x27;: pos.x - dragLastPos.x, 
                    &#x27;y&#x27;: pos.y - dragLastPos.y};
            }
            else {
                translation = {&#x27;x&#x27;: pos.x - dragStartPos.x, 
                        &#x27;y&#x27;: pos.y - dragStartPos.y};
            }
            dragLastPos = pos;
            // highlight trash when on it
            if ( Math.abs( pos.x - trash.x() ) &lt; 10 &amp;&amp;
                    Math.abs( pos.y - trash.y() ) &lt; 10   ) {
                trash.getChildren().each( function (tshape){ tshape.stroke(&#x27;orange&#x27;); });
                shape.stroke(&#x27;red&#x27;);
            }
            else {
                trash.getChildren().each( function (tshape){ tshape.stroke(&#x27;red&#x27;); });
                shape.stroke(colour);
            }
            // update group but not &#x27;this&#x27; shape
            var group = this.getParent();
            group.getChildren().each( function (shape) {
                if ( shape === this ) {
                    return;
                }
                shape.x( shape.x() + translation.x );
                shape.y( shape.y() + translation.y );
            });
            // reset anchors
            shapeEditor.resetAnchors();
            // draw
            drawLayer.draw();
        });
        // drag end event handling
        shape.on(&#x27;dragend&#x27;, function (/*event*/) {
            var pos = dragLastPos;
            dragLastPos = null;
            // delete case
            if ( Math.abs( pos.x - trash.x() ) &lt; 10 &amp;&amp;
                    Math.abs( pos.y - trash.y() ) &lt; 10   ) {
                // compensate for the drag translation
                var delTranslation = {&#x27;x&#x27;: pos.x - dragStartPos.x, 
                        &#x27;y&#x27;: pos.y - dragStartPos.y};
                var group = this.getParent();
                group.getChildren().each( function (shape) {
                    shape.x( shape.x() - delTranslation.x );
                    shape.y( shape.y() - delTranslation.y );
                });
                // restore colour
                shape.stroke(colour);
                // disable editor
                shapeEditor.disable();
                shapeEditor.setShape(null);
                shapeEditor.setImage(null);
                document.body.style.cursor = &#x27;default&#x27;;
                // delete command
                var delcmd = new dwv.tool.DeleteGroupCommand(this.getParent(), cmdName, drawLayer);
                delcmd.onExecute = fireEvent;
                delcmd.onUndo = fireEvent;
                delcmd.execute();
                app.getUndoStack().add(delcmd);
            }
            else {
                // save drag move
                var translation = {&#x27;x&#x27;: pos.x - dragStartPos.x, 
                        &#x27;y&#x27;: pos.y - dragStartPos.y};
                if ( translation.x !== 0 || translation.y !== 0 ) {
                    var mvcmd = new dwv.tool.MoveGroupCommand(this.getParent(), cmdName, translation, drawLayer);
                    mvcmd.onExecute = fireEvent;
                    mvcmd.onUndo = fireEvent;
                    app.getUndoStack().add(mvcmd);
                    // the move is handled by kinetic, trigger an event manually
                    fireEvent({&#x27;type&#x27;: &#x27;draw-move&#x27;});
                }
                // reset anchors
                shapeEditor.setAnchorsActive(true);
                shapeEditor.resetAnchors();
            }
            // remove trash
            trash.remove();
            // draw
            drawLayer.draw();
        });
    };

    /**
     * Initialise the tool.
     * @method init
     */
    this.init = function() {
        // set the default to the first in the list
        var shapeName = 0;
        for( var key in this.shapeFactoryList ){
            shapeName = key;
            break;
        }
        this.setShapeName(shapeName);
        // init gui
        if ( gui ) {
            // same for colour
            this.setLineColour(gui.getColours()[0]);
            // init html
            gui.initialise();
        }
        return true;
    };

    /**
     * Add an event listener on the app.
     * @method addEventListener
     * @param {String} type The event type.
     * @param {Object} listener The method associated with the provided event type.
     */
    this.addEventListener = function (type, listener)
    {
        if ( typeof listeners[type] === &quot;undefined&quot; ) {
            listeners[type] = [];
        }
        listeners[type].push(listener);
    };

    /**
     * Remove an event listener from the app.
     * @method removeEventListener
     * @param {String} type The event type.
     * @param {Object} listener The method associated with the provided event type.
     */
    this.removeEventListener = function (type, listener)
    {
        if( typeof listeners[type] === &quot;undefined&quot; ) {
            return;
        }
        for ( var i = 0; i &lt; listeners[type].length; ++i )
        {   
            if ( listeners[type][i] === listener ) {
                listeners[type].splice(i,1);
            }
        }
    };

    /**
     * Set the line colour of the drawing.
     * @method setLineColour
     * @param {String} colour The colour to set.
     */
    this.setLineColour = function (colour)
    {
        app.getStyle().setLineColour(colour);
    };

    // Private Methods -----------------------------------------------------------

    /**
     * Fire an event: call all associated listeners.
     * @method fireEvent
     * @param {Object} event The event to fire.
     */
    function fireEvent (event)
    {
        if ( typeof listeners[event.type] === &quot;undefined&quot; ) {
            return;
        }
        for ( var i=0; i &lt; listeners[event.type].length; ++i )
        {   
            listeners[event.type][i](event);
        }
    }

}; // Draw class

/**
 * Help for this tool.
 * @method getHelp
 * @returns {Object} The help content.
 */
dwv.tool.Draw.prototype.getHelp = function()
{
    return {
        &#x27;title&#x27;: &quot;Draw&quot;,
        &#x27;brief&#x27;: &quot;Allows to draw shapes on the image. &quot; +
            &quot;Choose the shape and its colour from the drop down menus. Once created, shapes &quot; +
            &quot;can be edited by selecting them. Anchors will appear and allow specific shape edition. &quot; +
            &quot;Drag the shape on the top red cross to delete it. All actions are undoable. &quot;,
        &#x27;mouse&#x27;: {
            &#x27;mouse_drag&#x27;: &quot;A single mouse drag draws the desired shape.&quot;,
        },
        &#x27;touch&#x27;: {
            &#x27;touch_drag&#x27;: &quot;A single touch drag draws the desired shape.&quot;,
        }
    };
};

/**
 * Set the shape name of the drawing.
 * @method setShapeName
 * @param {String} name The name of the shape.
 */
dwv.tool.Draw.prototype.setShapeName = function(name)
{
    // check if we have it
    if( !this.hasShape(name) )
    {
        throw new Error(&quot;Unknown shape: &#x27;&quot; + name + &quot;&#x27;&quot;);
    }
    this.shapeName = name;
};

/**
 * Check if the shape is in the shape list.
 * @method hasShape
 * @param {String} name The name of the shape.
 */
dwv.tool.Draw.prototype.hasShape = function(name) {
    return this.shapeFactoryList[name];
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
