<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/tools/livewire.js - dwv</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="dwv"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9.0beta</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/dwv.App.html">dwv.App</a></li>
                                <li><a href="../classes/dwv.browser.html">dwv.browser</a></li>
                                <li><a href="../classes/dwv.dicom.DataReader.html">dwv.dicom.DataReader</a></li>
                                <li><a href="../classes/dwv.dicom.DicomParser.html">dwv.dicom.DicomParser</a></li>
                                <li><a href="../classes/dwv.gui.html">dwv.gui</a></li>
                                <li><a href="../classes/dwv.gui.base.Draw.html">dwv.gui.base.Draw</a></li>
                                <li><a href="../classes/dwv.gui.base.FileLoad.html">dwv.gui.base.FileLoad</a></li>
                                <li><a href="../classes/dwv.gui.base.Filter.html">dwv.gui.base.Filter</a></li>
                                <li><a href="../classes/dwv.gui.base.Livewire.html">dwv.gui.base.Livewire</a></li>
                                <li><a href="../classes/dwv.gui.base.Loadbox.html">dwv.gui.base.Loadbox</a></li>
                                <li><a href="../classes/dwv.gui.base.Scroll.html">dwv.gui.base.Scroll</a></li>
                                <li><a href="../classes/dwv.gui.base.Sharpen.html">dwv.gui.base.Sharpen</a></li>
                                <li><a href="../classes/dwv.gui.base.Slider.html">dwv.gui.base.Slider</a></li>
                                <li><a href="../classes/dwv.gui.base.Sobel.html">dwv.gui.base.Sobel</a></li>
                                <li><a href="../classes/dwv.gui.base.Threshold.html">dwv.gui.base.Threshold</a></li>
                                <li><a href="../classes/dwv.gui.base.Toolbox.html">dwv.gui.base.Toolbox</a></li>
                                <li><a href="../classes/dwv.gui.base.Undo.html">dwv.gui.base.Undo</a></li>
                                <li><a href="../classes/dwv.gui.base.WindowLevel.html">dwv.gui.base.WindowLevel</a></li>
                                <li><a href="../classes/dwv.gui.base.ZoomAndPan.html">dwv.gui.base.ZoomAndPan</a></li>
                                <li><a href="../classes/dwv.html.html">dwv.html</a></li>
                                <li><a href="../classes/dwv.html.Layer.html">dwv.html.Layer</a></li>
                                <li><a href="../classes/dwv.html.Style.html">dwv.html.Style</a></li>
                                <li><a href="../classes/dwv.image.html">dwv.image</a></li>
                                <li><a href="../classes/dwv.image.filter.Sharpen.html">dwv.image.filter.Sharpen</a></li>
                                <li><a href="../classes/dwv.image.filter.Sobel.html">dwv.image.filter.Sobel</a></li>
                                <li><a href="../classes/dwv.image.filter.Threshold.html">dwv.image.filter.Threshold</a></li>
                                <li><a href="../classes/dwv.image.Image.html">dwv.image.Image</a></li>
                                <li><a href="../classes/dwv.image.lut.Rescale.html">dwv.image.lut.Rescale</a></li>
                                <li><a href="../classes/dwv.image.lut.Window.html">dwv.image.lut.Window</a></li>
                                <li><a href="../classes/dwv.image.Size.html">dwv.image.Size</a></li>
                                <li><a href="../classes/dwv.image.Spacing.html">dwv.image.Spacing</a></li>
                                <li><a href="../classes/dwv.image.View.html">dwv.image.View</a></li>
                                <li><a href="../classes/dwv.info.html">dwv.info</a></li>
                                <li><a href="../classes/dwv.io.File.html">dwv.io.File</a></li>
                                <li><a href="../classes/dwv.io.Url.html">dwv.io.Url</a></li>
                                <li><a href="../classes/dwv.math.BucketQueue.html">dwv.math.BucketQueue</a></li>
                                <li><a href="../classes/dwv.math.Circle.html">dwv.math.Circle</a></li>
                                <li><a href="../classes/dwv.math.Ellipse.html">dwv.math.Ellipse</a></li>
                                <li><a href="../classes/dwv.math.FastPoint2D.html">dwv.math.FastPoint2D</a></li>
                                <li><a href="../classes/dwv.math.IdGenerator.html">dwv.math.IdGenerator</a></li>
                                <li><a href="../classes/dwv.math.Line.html">dwv.math.Line</a></li>
                                <li><a href="../classes/dwv.math.Path.html">dwv.math.Path</a></li>
                                <li><a href="../classes/dwv.math.Point2D.html">dwv.math.Point2D</a></li>
                                <li><a href="../classes/dwv.math.Rectangle.html">dwv.math.Rectangle</a></li>
                                <li><a href="../classes/dwv.math.ROI.html">dwv.math.ROI</a></li>
                                <li><a href="../classes/dwv.math.Scissors.html">dwv.math.Scissors</a></li>
                                <li><a href="../classes/dwv.tool.html">dwv.tool</a></li>
                                <li><a href="../classes/dwv.tool.ChangeGroupCommand.html">dwv.tool.ChangeGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.DeleteGroupCommand.html">dwv.tool.DeleteGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.Draw.html">dwv.tool.Draw</a></li>
                                <li><a href="../classes/dwv.tool.DrawGroupCommand.html">dwv.tool.DrawGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.EllipseFactory.html">dwv.tool.EllipseFactory</a></li>
                                <li><a href="../classes/dwv.tool.Filter.html">dwv.tool.Filter</a></li>
                                <li><a href="../classes/dwv.tool.filter.Sharpen.html">dwv.tool.filter.Sharpen</a></li>
                                <li><a href="../classes/dwv.tool.filter.Sobel.html">dwv.tool.filter.Sobel</a></li>
                                <li><a href="../classes/dwv.tool.filter.Threshold.html">dwv.tool.filter.Threshold</a></li>
                                <li><a href="../classes/dwv.tool.LineFactory.html">dwv.tool.LineFactory</a></li>
                                <li><a href="../classes/dwv.tool.Livewire.html">dwv.tool.Livewire</a></li>
                                <li><a href="../classes/dwv.tool.MoveGroupCommand.html">dwv.tool.MoveGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.ProtractorFactory.html">dwv.tool.ProtractorFactory</a></li>
                                <li><a href="../classes/dwv.tool.RectangleFactory.html">dwv.tool.RectangleFactory</a></li>
                                <li><a href="../classes/dwv.tool.RoiFactory.html">dwv.tool.RoiFactory</a></li>
                                <li><a href="../classes/dwv.tool.RunFilterCommand.html">dwv.tool.RunFilterCommand</a></li>
                                <li><a href="../classes/dwv.tool.Scroll.html">dwv.tool.Scroll</a></li>
                                <li><a href="../classes/dwv.tool.ShapeEditor.html">dwv.tool.ShapeEditor</a></li>
                                <li><a href="../classes/dwv.tool.Toolbox.html">dwv.tool.Toolbox</a></li>
                                <li><a href="../classes/dwv.tool.UndoStack.html">dwv.tool.UndoStack</a></li>
                                <li><a href="../classes/dwv.tool.WindowLevel.html">dwv.tool.WindowLevel</a></li>
                                <li><a href="../classes/dwv.tool.ZoomAndPan.html">dwv.tool.ZoomAndPan</a></li>
                                <li><a href="../classes/dwv.ToolboxController.html">dwv.ToolboxController</a></li>
                                <li><a href="../classes/dwv.utils.html">dwv.utils</a></li>
                                <li><a href="../classes/dwv.ViewController.html">dwv.ViewController</a></li>
                                <li><a href="../classes/image.ImageFactory.html">image.ImageFactory</a></li>
                                <li><a href="../classes/image.ViewFactory.html">image.ViewFactory</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/browser.html">browser</a></li>
                                <li><a href="../modules/dicom.html">dicom</a></li>
                                <li><a href="../modules/gui.html">gui</a></li>
                                <li><a href="../modules/html.html">html</a></li>
                                <li><a href="../modules/image.html">image</a></li>
                                <li><a href="../modules/info.html">info</a></li>
                                <li><a href="../modules/io.html">io</a></li>
                                <li><a href="../modules/math.html">math</a></li>
                                <li><a href="../modules/tool.html">tool</a></li>
                                <li><a href="../modules/utils.html">utils</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/tools/livewire.js</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        /** 
                         * Tool module.
                         * @module tool
                         */
                        var dwv = dwv || {};
                        dwv.tool = dwv.tool || {};
                        var Kinetic = Kinetic || {};
                        
                        /**
                         * Livewire painting tool.
                         * @class Livewire
                         * @namespace dwv.tool
                         * @constructor
                         * @param {Object} app The associated application.
                         */
                        dwv.tool.Livewire = function(app)
                        {
                            /**
                             * Closure to self: to be used by event handlers.
                             * @property self
                             * @private
                             * @type WindowLevel
                             */
                            var self = this;
                            /**
                             * Livewire GUI.
                             * @property gui
                             * @type Object
                             */
                            var gui = new dwv.gui.Livewire(app);
                            /**
                             * Interaction start flag.
                             * @property started
                             * @type Boolean
                             */
                            this.started = false;
                            
                            /**
                             * Draw command.
                             * @property command
                             * @private
                             * @type Object
                             */
                            var command = null;
                            /**
                             * Current shape group.
                             * @property shapeGroup
                             * @private
                             * @type Object
                             */
                            var shapeGroup = null;
                            /**
                             * Drawing style.
                             * @property style
                             * @type Style
                             */
                            this.style = new dwv.html.Style();
                            
                            /**
                             * Path storage. Paths are stored in reverse order.
                             * @property path
                             * @private
                             * @type Path
                             */
                            var path = new dwv.math.Path();
                            /**
                             * Current path storage. Paths are stored in reverse order.
                             * @property currentPath
                             * @private
                             * @type Path
                             */
                            var currentPath = new dwv.math.Path();
                            /**
                             * List of parent points.
                             * @property parentPoints
                             * @private
                             * @type Array
                             */
                            var parentPoints = [];
                            /**
                             * Tolerance.
                             * @property tolerance
                             * @private
                             * @type Number
                             */
                            var tolerance = 5;
                            
                            /**
                             * Clear the parent points list.
                             * @method clearParentPoints
                             * @private
                             */
                            function clearParentPoints() {
                                for( var i = 0; i &lt; app.getImage().getSize().getNumberOfRows(); ++i ) {
                                    parentPoints[i] = [];
                                }
                            }
                            
                            /**
                             * Clear the stored paths.
                             * @method clearPaths
                             * @private
                             */
                            function clearPaths() {
                                path = new dwv.math.Path();
                                currentPath = new dwv.math.Path();
                            }
                            
                            /**
                             * Scissor representation.
                             * @property scissors
                             * @private
                             * @type Scissors
                             */
                            var scissors = new dwv.math.Scissors();
                            
                            /**
                             * Handle mouse down event.
                             * @method mousedown
                             * @param {Object} event The mouse down event.
                             */
                            this.mousedown = function(event){
                                // first time
                                if( !self.started ) {
                                    self.started = true;
                                    self.x0 = event._x;
                                    self.y0 = event._y;
                                    // clear vars
                                    clearPaths();
                                    clearParentPoints();
                                    // do the training from the first point
                                    var p = new dwv.math.FastPoint2D(event._x, event._y);
                                    scissors.doTraining(p);
                                    // add the initial point to the path
                                    var p0 = new dwv.math.Point2D(event._x, event._y);
                                    path.addPoint(p0);
                                    path.addControlPoint(p0);
                                }
                                else {
                                    // final point: at &#x27;tolerance&#x27; of the initial point
                                    if( (Math.abs(event._x - self.x0) &lt; tolerance) &amp;&amp; (Math.abs(event._y - self.y0) &lt; tolerance) ) {
                                        // draw
                                        self.mousemove(event);
                                        console.log(&quot;Done.&quot;);
                                        // save command in undo stack
                                        app.getUndoStack().add(command);
                                        // set flag
                                        self.started = false;
                                    }
                                    // anchor point
                                    else {
                                        path = currentPath;
                                        clearParentPoints();
                                        var pn = new dwv.math.FastPoint2D(event._x, event._y);
                                        scissors.doTraining(pn);
                                        path.addControlPoint(currentPath.getPoint(0));
                                    }
                                }
                            };
                        
                            /**
                             * Handle mouse move event.
                             * @method mousemove
                             * @param {Object} event The mouse move event.
                             */
                            this.mousemove = function(event){
                                if (!self.started)
                                {
                                    return;
                                }
                                // set the point to find the path to
                                var p = new dwv.math.FastPoint2D(event._x, event._y);
                                scissors.setPoint(p);
                                // do the work
                                var results = 0;
                                var stop = false;
                                while( !parentPoints[p.y][p.x] &amp;&amp; !stop)
                                {
                                    console.log(&quot;Getting ready...&quot;);
                                    results = scissors.doWork();
                                    
                                    if( results.length === 0 ) { 
                                        stop = true;
                                    }
                                    else {
                                        // fill parents
                                        for( var i = 0; i &lt; results.length-1; i+=2 ) {
                                            var _p = results[i];
                                            var _q = results[i+1];
                                            parentPoints[_p.y][_p.x] = _q;
                                        }
                                    }
                                }
                                console.log(&quot;Ready!&quot;);
                                
                                // get the path
                                currentPath = new dwv.math.Path();
                                stop = false;
                                while (p &amp;&amp; !stop) {
                                    currentPath.addPoint(new dwv.math.Point2D(p.x, p.y));
                                    if(!parentPoints[p.y]) { 
                                        stop = true;
                                    }
                                    else { 
                                        if(!parentPoints[p.y][p.x]) { 
                                            stop = true;
                                        }
                                        else {
                                            p = parentPoints[p.y][p.x];
                                        }
                                    }
                                }
                                currentPath.appenPath(path);
                                
                                // remove previous draw
                                if ( shapeGroup ) {
                                    shapeGroup.destroy();
                                }
                                // create shape
                                var factory = new dwv.tool.RoiFactory();
                                shapeGroup = factory.create(currentPath.pointArray, self.style);
                                // draw shape command
                                command = new dwv.tool.DrawGroupCommand(shapeGroup, &quot;livewire&quot;, app.getDrawLayer());
                                // draw
                                command.execute();
                            };
                        
                            /**
                             * Handle mouse up event.
                             * @method mouseup
                             * @param {Object} event The mouse up event.
                             */
                            this.mouseup = function(/*event*/){
                                // nothing to do
                            };
                            
                            /**
                             * Handle mouse out event.
                             * @method mouseout
                             * @param {Object} event The mouse out event.
                             */
                            this.mouseout = function(event){
                                // treat as mouse up
                                self.mouseup(event);
                            };
                            
                            /**
                             * Handle touch start event.
                             * @method touchstart
                             * @param {Object} event The touch start event.
                             */
                            this.touchstart = function(event){
                                // treat as mouse down
                                self.mousedown(event);
                            };
                        
                            /**
                             * Handle touch move event.
                             * @method touchmove
                             * @param {Object} event The touch move event.
                             */
                            this.touchmove = function(event){
                                // treat as mouse move
                                self.mousemove(event);
                            };
                        
                            /**
                             * Handle touch end event.
                             * @method touchend
                             * @param {Object} event The touch end event.
                             */
                            this.touchend = function(event){
                                // treat as mouse up
                                self.mouseup(event);
                            };
                        
                            /**
                             * Handle key down event.
                             * @method keydown
                             * @param {Object} event The key down event.
                             */
                            this.keydown = function(event){
                                app.onKeydown(event);
                            };
                        
                            /**
                             * Setup the tool GUI.
                             * @method setup
                             */
                            this.setup = function ()
                            {
                                gui.setup();
                            };
                            
                            /**
                             * Enable the tool.
                             * @method enable
                             * @param {Boolean} bool The flag to enable or not.
                             */
                            this.display = function(bool){
                                gui.display(bool);
                                // TODO why twice?
                                this.init();
                            };
                        
                            /**
                             * Initialise the tool.
                             * @method init
                             */
                            this.init = function()
                            {
                                // set the default to the first in the list
                                this.setLineColour(gui.getColours()[0]);
                                // init html
                                gui.initialise();
                                
                                //scissors = new dwv.math.Scissors();
                                scissors.setDimensions(
                                        app.getImage().getSize().getNumberOfColumns(),
                                        app.getImage().getSize().getNumberOfRows() );
                                scissors.setData(app.getImageData().data);
                            };
                            
                        }; // Livewire class
                        
                        /**
                         * Help for this tool.
                         * @method getHelp
                         * @returns {Object} The help content.
                         */
                        dwv.tool.Livewire.prototype.getHelp = function()
                        {
                            return {
                                &#x27;title&#x27;: &quot;Livewire&quot;,
                                &#x27;brief&#x27;: &quot;The Livewire tool is a semi-automatic segmentation tool &quot; +
                                    &quot;that proposes to the user paths that follow intensity edges.&quot; + 
                                    &quot;Click once to initialise and then move the mouse to see &quot; + 
                                    &quot;the proposed paths. Click again to build your contour. &quot; + 
                                    &quot;The process stops when you click on the first root point. &quot; +
                                    &quot;BEWARE: the process can take time!&quot;
                            };
                        };
                        
                        /**
                         * Set the line color of the drawing.
                         * @method setLineColour
                         * @param {String} colour The colour to set.
                         */
                        dwv.tool.Livewire.prototype.setLineColour = function(colour)
                        {
                            // set style var
                            this.style.setLineColor(colour);
                        };
                        
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
