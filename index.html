<html>

<head>
<title>DICOM Web Viewer</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<link rel="stylesheet" href="style.css">
</head>

<body>
     
<script type="text/javascript" src="js/reader/LocalFileReader.js"></script>
<script type="text/javascript" src="js/dicom/DicomInputStreamReader.js"></script>
<script type="text/javascript" src="js/dicom/DicomElement.js"></script>
<script type="text/javascript" src="js/dicom/DicomParser.js"></script>
<script type="text/javascript" src="js/dicom/DicomImage.js"></script>
<script type="text/javascript" src="js/dicom/LookupTable.js"></script>
<script type="text/javascript" src="js/tools/rect.js"></script>
<script type="text/javascript" src="js/tools/roi.js"></script>
<script type="text/javascript" src="js/tools/line.js"></script>
<script type="text/javascript" src="js/tools/circle.js"></script>
<script type="text/javascript" src="js/tools/windowLevel.js"></script>

<script type="text/javascript">

    // DICOM values
    var gImage;
    
    var gIookupTable;
    var gHuLookupTable; 
    var gLookupObj;
       
    var gPixelBuffer;
    var gImageLoaded=0;
    
    // The active tool instance.
    var gSelectedTool = false;
    var gDefaultTool = 'windowLevel';
    // This object holds the implementation of each drawing tool.
    var gTools = {};
    var gBaseCanvas;
    var gBaseContext;    
    var gCanvas;
    var gContext;    
    var gMyImageData;
    
    // style
    var gFontSize = 12;
    var gFontStr = "normal "+gFontSize+"px sans-serif";
    var gLineHeight = gFontSize + gFontSize/5;
    var gLineColor = "yellow";
    var gTextColor = "#fff";

    function gMouseOverColor()
    {
        document.body.style.cursor="pointer";
    }
    
    function gMouseOutColor()
    {
        document.body.style.cursor="auto";
    }
    
    function gSetLineColor(color)
    {
        // set global var
        gLineColor = color;
        // reset borders
        var tr = document.getElementById("colours");
        var tds = tr.getElementsByTagName("td");
        for (var i = 0; i < tds.length; i++)
        {
            tds[i].style.border = "#fff solid 2px";
        }
        // set selected border
        var td = document.getElementById(color);
        td.style.border = "#00f solid 2px";
    }
    
    function gInitCanvas()
    {
        // Find the canvas element.
        gBaseCanvas = document.getElementById('imageView');
        if (!gBaseCanvas)
        {
            alert('Error: I cannot find the canvas element!');
            return;
        }

        if (!gBaseCanvas.getContext)
        {
            alert('Error: no canvas.getContext!');
            return;
        }

        // Get the 2D canvas context.
        gBaseContext = gBaseCanvas.getContext('2d');
        if (!gBaseContext)
        {
            alert('Error: failed to getContext!');
            return;
        }

        // Add the temporary canvas.
        var container = gBaseCanvas.parentNode;
        gCanvas = document.createElement('canvas');
        if (!gCanvas)
        {
            alert('Error: I cannot create a new canvas element!');
            return;
        }

        gBaseCanvas.width = gImage.getSize()[0];
        gBaseCanvas.height = gImage.getSize()[1];
        
        gCanvas.id = 'imageTemp';
        gCanvas.width = gBaseCanvas.width;
        gCanvas.height = gBaseCanvas.height;
        container.appendChild(gCanvas);
        gContext = gCanvas.getContext('2d');
    }
    
    function gInitTools()
    {
        // tool list
        gTools.rect = tools_rect;
        gTools.roi = tools_roi;
        gTools.line = tools_line;
        gTools.circle = tools_circle;
        gTools.windowLevel = tools_windowLevel;
    
        // Get the tool select input.
        var tool_select = document.getElementById('dtool');
        if (!tool_select)
        {
            alert('Error: failed to get the dtool element!');
            return;
        }
        tool_select.addEventListener('change', gEventToolChange, false);

        // Activate the default tool.
        if (gTools[gDefaultTool])
        {
            gSelectedTool = new gTools[gDefaultTool]();
            tool_select.value = gDefaultTool;
        }
    }

    // The event handler for any changes made to the tool selector.
    function gEventToolChange(event)
    {
        if (gTools[this.value])
        {
            gSelectedTool = new gTools[this.value]();
        }
    }

    // This function draws the #imageTemp canvas on top of #imageView,
    // after which #imageTemp is cleared. This function is called each time when the
    // user completes a drawing operation.
    function gImgUpdate() 
    {
        gBaseContext.drawImage(gCanvas, 0, 0);
        gContext.clearRect(0, 0, gCanvas.width, gCanvas.height);
    } 

    // The general-purpose event handler. This function just determines the mouse 
    // position relative to the canvas element.
    function gEvCanvas(event)
    {
        if (event.layerX || event.layerX == 0)
        { 
            // Firefox
            event._x = event.layerX;
            event._y = event.layerY;
        }
        else if (event.offsetX || event.offsetX == 0)
        {
            // Opera
            event._x = event.offsetX;
            event._y = event.offsetY;
        }

        if(event._x >= 0 
            && event._y >= 0 
            && event._x < gImage.getSize()[0] 
            && event._y < gImage.getSize()[1] )
        {
            // Call the event handler of the tool.
            var func = gSelectedTool[event.type];
            if (func)
            {
                func(event);
            }
        }
    }

    function gLoadDicom(evt) 
    {
        file = evt.target.files[0]
        
        var myreader = new FileReader();
        myreader.onload = function() {
            return function(e) {
                gParseAndLoadDicom(e.target.result);
                var span = document.createElement('div');
                span.innerHTML = ['<p><b>', e.target.result.length, '</b></p>'].join('');
                document.getElementById('tagSearch').insertBefore(span, null);
            };
        }();
        myreader.readAsBinaryString(file);
    }
    
    function gGetContextPath()
    {
        var path = top.location.pathname;
        if (document.all)
        {
            path = path.replace(/\\/g,"/");
        }
        path = path.substr(0,path.lastIndexOf("/")+1);        
        return path;
    }
    
    function gParseAndLoadDicom(file)
    {    
        var reader = new DicomInputStreamReader();    
        reader.readDicom(file);
        var dicomBuffer = reader.getInputBuffer();
        var dicomReader = reader.getReader();
        var dicomParser = new DicomParser(dicomBuffer,dicomReader);
        dicomParser.parseAll();     
        
        // tag list table      
        var table = document.getElementById("tagList")
        
        var numberOfRows;
        var numberOfColumns;
        var rowSpacing;
        var columnSpacing;
        var windowWidth;
        var windowCenter;
        var rescaleIntercept;
        var rescaleSlope;
        
        var elementindex=0;
        for(;elementindex<dicomParser.dicomElement.length;elementindex++)
        {
            var dicomElement=dicomParser.dicomElement[elementindex];            
            if(dicomElement.name=="numberOfRows")
            {
                numberOfRows=dicomElement.value[0];
            }
            else if(dicomElement.name=="numberOfColumns")
            {
                numberOfColumns=dicomElement.value[0];
            }
            else if(dicomElement.name=="pixelSpacing")
            {
                rowSpacing=parseFloat(dicomElement.value[0]);    
                columnSpacing=parseFloat(dicomElement.value[1]);    
            }
            else if(dicomElement.name=="windowWidth")
            {
                windowWidth=dicomElement.value[0];
            }
            else if(dicomElement.name=="windowCenter")
            {
                windowCenter=dicomElement.value[0];            
            }
            else if(dicomElement.name=="rescaleSlope")
            {
                rescaleSlope=parseInt(dicomElement.value);    
            }
            else if(dicomElement.name=="rescaleIntercept")
            {
                rescaleIntercept=parseInt(dicomElement.value);
            }

            var lastRow = table.rows.length;
            var row = table.insertRow(lastRow);
            var cell0 = row.insertCell(0);
            cell0.appendChild(document.createTextNode(dicomElement.group+", "+dicomElement.element));
            var cell1 = row.insertCell(1);
            cell1.appendChild(document.createTextNode(dicomElement.name));
            var cell2 = row.insertCell(2);
            cell2.appendChild(document.createTextNode(dicomElement.value));
        } 
               
        gPixelBuffer = dicomParser.pixelBuffer;
        
        gImage = new DicomImage(
            [numberOfRows, numberOfColumns],
            [rowSpacing, columnSpacing]);
            
        gLookupObj = new LookupTable();
        gLookupObj.setData( windowCenter, windowWidth, rescaleSlope, rescaleIntercept);
        gLookupObj.calculateHULookup();
        
        gInitCanvas();
        
        gBaseContext.fillRect( 0, 0, numberOfRows, numberOfColumns );    
        gMyImageData = gBaseContext.getImageData( 0, 0, numberOfRows, numberOfColumns);        
        gGenImage();        
        gImageLoaded=1;
        
        gInitTools();
        gSetLineColor(gLineColor);
        
        // Attach the mousedown, mousemove and mouseup event listeners.
        gCanvas.addEventListener('mousedown', gEvCanvas, false);
        gCanvas.addEventListener('mousemove', gEvCanvas, false);
        gCanvas.addEventListener('mouseup',   gEvCanvas, false);
    }
    
    function gGenImage()
    {        
        gLookupObj.calculateLookup();
        var n=0;    
        for(var yPix=0; yPix < gImage.getSize()[1]; yPix++)
        {
            for(var xPix=0; xPix < gImage.getSize()[0];xPix++)
            {        
                var offset = (yPix * gImage.getSize()[0] + xPix) * 4;                    
                var pxValue = gLookupObj.ylookup[ gPixelBuffer[n] ];    
                n++;               
                gMyImageData.data[offset] = parseInt(pxValue);
                gMyImageData.data[offset+1] = parseInt(pxValue);
                gMyImageData.data[offset+2] = parseInt(pxValue);
            }
        }            
        gBaseContext.putImageData(gMyImageData, 0,0);
    }    
</script>

<!-- Header -->
<h1>DICOM Web Viewer (<a href="https://github.com/ivmartel/dwv">dwv</a>)</h1>

<!-- Left -->
<div id="left">
Tool: <select id="dtool">
  <option value="windowLevel">Window/Level</option>
  <option value="rect">Draw: Rectangle</option>
  <option value="circle">Draw: Circle</option>
  <option value="roi">Draw: ROI</option>
  <option value="line">Draw: Line</option>
</select>

<br>&nbsp;

<br>Color: 
<table name="colourChooser" class="colourChooser">
<tr id="colours" onmouseover="gMouseOverColor()" onmouseout="gMouseOutColor()">
<td id="black" onclick="gSetLineColor('black')">&nbsp;</td>
<td id="white" onclick="gSetLineColor('white')">&nbsp;</td>
<td id="red" onclick="gSetLineColor('red')">&nbsp;</td>
<td id="green" onclick="gSetLineColor('green')">&nbsp;</td>
<td id="blue" onclick="gSetLineColor('blue')">&nbsp;</td>
<td id="yellow" onclick="gSetLineColor('yellow')">&nbsp;</td>
<td id="lime" onclick="gSetLineColor('lime')">&nbsp;</td>
<td id="fuchsia" onclick="gSetLineColor('fuchsia')">&nbsp;</td>
</tr>
</table>

<div id="presetSelector"></div>
<script type="text/javascript">gGetPresetSelector();</script>

</div>

<!-- Container -->
<div id="container">
<canvas id="imageView" width="200" height="200" ></canvas>
</div>

<!-- Right -->
<div id="right">
<form>
Path: <input type="file" id="files" name="files[]" multiple />
</form>

<script type="text/javascript">
    document.getElementById('files').addEventListener('change', gLoadDicom, false);
</script>

<form>
Search Tags: <input type="text" id="tagSearch" name="tagSearch" multiple />
<input type="submit" value="Submit" />
</form>

<table id="tagList" class="tagList">
<tr>
<th>Tag</th>
<th>Name</th>
<th>Value</th>
</tr>
</table>

</div>

</body>
</html>

